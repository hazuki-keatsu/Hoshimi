# 光照渲染管线开发文档 (Lighting Render Pipeline)

> **注意**: 本文档属于远期技术规划 (Long-term Roadmap)，暂不列入 MVP 阶段的首要开发目标。

## 1. 设计背景与挑战
传统游戏引擎的光照渲染通常依赖复杂的材质贴图（法线贴图、高光贴图、AO贴图等）来实现逼真的光影效果。然而，对于 GalGame/Visual Novel 引擎而言，这种做法存在显著弊端：
1.  **制作成本高**: 画师通常只提供一张 PSD 或 PNG 立绘，要求其额外制作法线/高光贴图不现实。
2.  **门槛过高**: 强迫创作者理解图形学概念（材质、UV、PBR）违背了 Hoshimi 引擎“易用性”的核心理念。
3.  **风格不符**: 二次元美术风格往往通过画师的手绘笔触表达光影，强行套用物理渲染（PBR）可能导致“油腻感”。

因此，本引擎采用 **"单张贴图 + 自动光照分区" (Single Texture + Auto Lighting Partition)** 的方案。

## 2. 核心方案：单贴图 + 自动光照分区

核心思路是**基于图像本身的亮度 (Luminance)、透明度 (Alpha) 和色彩信息，自动推导光照影响区域**，而非依赖手动标注的材质分区。

### 2.1 立绘与背景：基于亮度的自动分层
2D 图像的亮度值（`L = 0.299*R + 0.587*G + 0.114*B`）天然包含了物体材质的光学特性信息。引擎将根据亮度区间自动应用不同的光照公式：

*   **高光区 (Highlight)** `(Luminance > 0.8)`
    *   **判定**: 角色头发的反光、眼睛高光、金属饰品。
    *   **规则**: **弱受全局光照影响**。保留原始亮度，仅轻微叠加环境光色调，防止在暗场景（如夜晚）中高光部分被彻底“吞掉”而失去质感。
*   **漫反射区 (Diffuse)** `(0.2 < Luminance ≤ 0.8)`
    *   **判定**: 角色皮肤、衣物主体、背景墙面。
    *   **规则**: **完全受全局光照影响**。正常叠加环境光颜色、强度和阴影。
*   **阴影区 (Shadow)** `(Luminance ≤ 0.2)`
    *   **判定**: 头发暗部、衣物褶皱、深色物体。
    *   **规则**: **强化阴影表现**。暗部会变得更暗，以增强画面的立体感。

#### 片元着色器伪代码 (Fragment Shader Prototype)
```glsl
// 全局光照上下文（所有图层共享）
uniform vec3 ambientColor;     // 环境光颜色
uniform float ambientIntensity; // 环境光强度
uniform vec3 toneShift;        // 色调偏移
uniform float shadowStrength;   // 阴影强度

// 输入：当前像素的原始颜色（单张贴图采样结果）
in vec4 originalColor;

void main() {
    // 1. 计算当前像素的亮度
    float luminance = dot(originalColor.rgb, vec3(0.299, 0.587, 0.114));
    
    // 2. 根据亮度划分光照影响区域
    vec3 finalColor = originalColor.rgb;
    
    if (luminance > 0.8) {
        // [高光区]：仅轻微叠加色调，保留原始高光亮度
        finalColor = mix(finalColor, finalColor * toneShift, 0.2);
    } else if (luminance > 0.2) {
        // [漫反射区]：标准光照模型，受环境光和色调完全影响
        finalColor = finalColor * ambientColor * ambientIntensity * toneShift;
    } else {
        // [阴影区]：叠加阴影强度，使暗部更深邃
        finalColor = finalColor * (1.0 - shadowStrength) * ambientColor;
    }
    
    // 输出最终颜色（保留Alpha通道）
    gl_FragColor = vec4(finalColor, originalColor.a);
}
```

### 2.2 UI 系统：基于 Alpha 通道的光照豁免
UI 界面通常需要保持高可读性，不能像场景物体那样被环境光染成漆黑（例如在深夜模式下）。利用 Alpha 通道区分：

*   **UI 主体 (Alpha = 1.0)**:
    *   **判定**: 文本框底板、按钮文字、图标主体。
    *   **规则**: **光照豁免/弱影响**。仅受全局亮度调节（防止过亮刺眼），色调偏移系数 ≤ 0.2，保证 UI 清晰可读。
*   **UI 装饰 (0 < Alpha < 1.0)**:
    *   **判定**: 对话框的半透明渐变边缘、发光特效、装饰纹样。
    *   **规则**: **完全受光照影响**。让装饰部分融入场景氛围（如在夕阳下泛红），增强沉浸感。

### 2.3 进阶选项：简易材质标记 (Optional)
为了给予高级开发者少量控制权，且不引入复杂流程，可提供基于颜色标记的简易机制：
*   **约定**: 图像中 `纯红色 (#FF0000)` 像素被视为强制高光，`纯蓝色 (#0000FF)` 被视为强制阴影。
*   **流程**: 引擎在渲染前预处理检测这些特定像素，应用特殊光照规则，然后恢复其邻近像素的颜色。
*   **优势**: 开发者只需在画图软件中用 1px 画笔点选即可，无需制作额外文件。

## 3. 方案优势分析

1.  **零额外资源成本 (Zero-Cost Assets)**:
    开发者只需提供常规的 2D 贴图 (PNG/JPG)，无需制作法线、高光等材质分区贴图，完全符合 GalGame 轻量化开发需求。
2.  **低学习成本 (Low Learning Curve)**:
    不需要开发者理解“材质、UV、法线”等 3D 图形学概念。光照效果完全由引擎自动计算，开发者仅需调整全局参数（如“设为黄昏”、“设为深夜”）。
3.  **效果自然 (Natural Aesthetics)**:
    基于亮度/Alpha 的自动分区算法贴合人眼对“高光/暗部”的直观视觉认知，生成的光影效果在二次元画风下自然且不违和。
4.  **性能极佳 (High Performance)**:
    所有计算均在 GPU 的片元着色器 (Fragment Shader) 中一次性完成，逻辑简单（仅亮度判断 + 颜色混合），无额外纹理采样，适配低配移动设备。
